## 1 프로세스 복제
### 1.1 프로세스 복제

#### 1.1.1 프로세스는 멀티 태스킹을 위해 복제함
- 복수개의 CPU를 가진 경우 성능 향상을 기대할 수 있음
- 복제된 프로세스사이에서 통신이 일어날 경우 통신 비용에 따라 오히려 성능이 하락 할 수 있음
- 각 프로세스가 독립적으로 동작하거나 프로세스간 통신비용이 적을 때 효과적
- 통신 비용이 적어도 프로세스의 절대적 수가 많으면 성능하락 할 수 있음
- 복제된 프로세스들이 사용하는 파일이나 I/O는 mmap을 사용하는걸 고려해야함
- ls가 대표적
fork로 프로세스를 만들고 exec를 호출해 /bin/ls로 교체함
- fork-exec로 한번에 호출가능
- 비슷한 기능으로 popen, system이 있음 (다른 장에서 정리)

#### 1.1.2 posix_spawn
- fork-exec를 대체할 명령이 제안됨
- fork는 부모 프로세스를 복제할 때 모든 정적인 정보를 복제함
( 힙, Static, IPC, 열린파일, Signal, 마스크)
- fork-exec를 사용하는 경우에는 대부분 부모 프로세스의 열린파일이나 IPC자원은 사용하지 않음
이 정보를 복제하는 것이 오버헤드
- posix_spwan은 부모의 정적 정보를 선택적으로 복제할 수 있음


### 1.2 fork
- 호출이 성공하면 프로세스가 복제되고 pid_t(int)가 리턴된다
> - **0** : 자식 프로세스에게 리턴됨
> - **양수** : 부모 프로세스에게 리턴됨 (야식의 PID)
> - **-1** : 에러

- 부모 프로세스에서는 자식 프로세스 처리를 기다리기 위해 wait나 waitpid를 이용할 수 있음 (9장)
- pstree -pl로 프로세스를 트리 형태로 볼 수 있음

### 1.3 vfork
- fork-exec 를 가볍게 동작하게 하기 위해 만들어짐
- fork-exec를 호출하면 exec가 호출되는 순간 fork로 복제되었던 페이지 테이블이 모두 해제됨
 사용하지도 않는 페이지 테이블이 복제되어 오버헤드 발생
- vfork는 페이지 테이블을 복사하지 않음
- 현재는 fork에 COW (copy on write) 기능이 추가되어 vfork는 사용하지 않음

### 1.4 exec
- 현재 실행중인 프로세스 이미지를 새로운 프로세스 이미지로 교체함
- 프로세스의 실행 코드는 대체 되지만 기존 PID, PPID, 파일 기술자 등의 정보는 유지됨
- 파일명만 넣는 경우 -cl, -cle, -cv, -cve는 현재 작업디렉토리를 찾고 clp, cvp는 PATH에 등록된 디렉토리를 찾는다.
함수 원형에서 첫 인자명이 path인 경우 현재 디렉토리를 찾고 file인 경우에는 PATH 디렉토리를 찾는다.
- FD_CLOEXEC 플레그를 지정하면 exec가 실행될 때 해당 기술자가 닫힌다

### 1.5 system
- forc-exec를 간단히 구현한 기능
- 실행명령이 동작하는 동안 부모프로세스가 정지됨
SIGCHLD, SIGINT, SIGQUIT 모두 블록됨

### 1.6 posix_spwan
- file_actions, attrp 인수에 NULL을 지정하면 forc-exec와 동일하게 동작함 (모든 부모의 자원 복제)
- 전통적인 유닉스 함수들은 성공시 0 , 실패시 -1을 반환했으나 쓰레드와 비동기처리가 용되면서 errno사용이 어려워짐
- POSIX계열 함수들은 성공시 0, 실패시 errno가 가지던 양수값을 반환하게함
posix_spwan도 동일함
- 반환값이 errno으로 변경되면서 PID가 첫번째 포인터 변수로 이동됨
- 세번째 인수 posix_spawn_file_actions_t 구조체를 통해 FD 복제 여부를 선택할 수 있다.
- 네번째 인수 posix_spawnatrr_t 구조체를 통해 EUID, 프로세스 그룹, 기본 시그널 작동, 시그널 블록 마스크, 스케줄링 파라미터, 스케줄러를 설정할 수 있다.
POSIX_SPAWN_RESETIDS 플레그를 세팅하면 자식의 EID는 부모의 RUID로 변경되지만
실행될 파일에 SetUID비트가 설정되어 있다면 해당 플레그는 무시된다.
- 시그널 마스크는 시그널이 전달되는 통로
해제시 시그널 전달 가능, 설정시 시그널 전달 불가